<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ö–æ–º–Ω–∞—Ç—ã</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  // üî• –¢–í–û–ò –î–ê–ù–ù–´–ï FIREBASE (–∑–∞–º–µ–Ω–∏ —Å–≤–æ–∏–º–∏)
  const firebaseConfig = {
    apiKey: "–¢–í–û–ô_API_KEY",
    authDomain: "–¢–í–û–ô_–ü–†–û–ï–ö–¢.firebaseapp.com",
    databaseURL: "https://–¢–í–û–ô_–ü–†–û–ï–ö–¢-default-rtdb.firebaseio.com",
    projectId: "–¢–í–û–ô_–ü–†–û–ï–ö–¢",
    storageBucket: "–¢–í–û–ô_–ü–†–û–ï–ö–¢.appspot.com",
    messagingSenderId: "XXX",
    appId: "1:XXX:web:XXX"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>
</head>
<body>
  <div class="container">
    <div class="room-list" id="roomList"></div>
    <video id="player" controls style="display:none;width:100%;margin-top:10px;background:#000;"></video>
    <button class="add-btn" id="addRoom">+</button>
  </div>

  <div id="sidePanel" class="side-panel">
    <div class="avatar"></div>
    <div class="nickname" id="nickname">username</div>
  </div>

  <button id="arrowBtn" class="arrow-btn">‚ùØ</button>

<script src="storage.js"></script>
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
const roomList = document.getElementById("roomList");
const addRoom = document.getElementById("addRoom");
const player = document.getElementById("player");
const sidePanel = document.getElementById("sidePanel");
const arrowBtn = document.getElementById("arrowBtn");
const nicknameEl = document.getElementById("nickname");

// –ù–∏–∫–Ω–µ–π–º
nicknameEl.textContent = Storage.getNickname() || "username";

// üîÑ –†–µ–Ω–¥–µ—Ä –∫–æ–º–Ω–∞—Ç –∏–∑ Firebase
function renderRooms(rooms) {
  roomList.innerHTML = "";
  if (!rooms || Object.keys(rooms).length === 0) {
    roomList.innerHTML = "<p style='color:#999;text-align:center;margin-top:40%;'>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</p>";
    return;
  }

  Object.values(rooms).forEach(room => {
    const div = document.createElement("div");
    div.className = "room-item";
    div.innerHTML = `<div class="room-circle"></div><span>${room.name}</span>`;
    div.onclick = () => {
      Storage.setCurrentRoom(room.name);
      db.ref("rooms/" + room.name).update({ visited: true });
      window.location.href = `room.html?room=${encodeURIComponent(room.name)}`;
    };
    roomList.appendChild(div);
  });
}

// üî• –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Firebase
db.ref("rooms").on("value", snapshot => {
  renderRooms(snapshot.val());
});

// ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
addRoom.onclick = () => {
  const newRoom = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:");
  if (!newRoom) return;

  const roomData = { name: newRoom.trim(), created: Date.now(), visited: false };
  db.ref("rooms/" + roomData.name).set(roomData);

  // –≤—ã–±–æ—Ä –≤–∏–¥–µ–æ
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'video/*';
  fileInput.onchange = e => {
    const file = e.target.files[0];
    if (file) {
      player.src = URL.createObjectURL(file);
      player.style.display = 'block';
      player.play();
    }
  };
  fileInput.click();

  // –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  setTimeout(async () => {
    const snap = await db.ref("rooms/" + roomData.name).once("value");
    const room = snap.val();
    if (room && !room.visited && Date.now() - room.created > 300000) {
      db.ref("rooms/" + roomData.name).remove();
      console.log("–ö–æ–º–Ω–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∞:", roomData.name);
    }
  }, 300000);

  window.location.href = `room.html?room=${encodeURIComponent(newRoom)}`;
};

// üîÑ –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
let isOpen = false;
arrowBtn.onclick = () => {
  isOpen = !isOpen;
  if (isOpen) {
    sidePanel.classList.add("open");
    arrowBtn.textContent = "‚ùÆ";
    arrowBtn.style.right = "320px";
  } else {
    sidePanel.classList.remove("open");
    arrowBtn.textContent = "‚ùØ";
    arrowBtn.style.right = "50px";
  }
};
</script>
</body>
</html>

