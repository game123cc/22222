<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Комнаты</title>
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body {
      background-color: #2f4f4f;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
    }

    .container {
      background-color: #1e1e1e;
      border-radius: 15px;
      width: 900px;
      height: 700px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 1;
    }

    .room-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px;
    }

    .room-item {
      display: flex;
      align-items: center;
      height: 65px;
      margin: 12px 0;
      border-radius: 40px;
      background: linear-gradient(to right, #000 35%, #999 35%);
      box-shadow: inset 0 0 0 2px #1e1e1e;
      cursor: pointer;
      transition: transform 0.2s ease;
      padding-left: 20px;
      position: relative;
    }

    .room-item:hover {
      transform: scale(1.02);
    }

    .room-circle {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background-color: #333;
      margin-right: 15px;
    }

    .room-item span {
      color: white;
      font-size: 17px;
      font-weight: 500;
    }

    .add-btn {
      position: absolute;
      bottom: 25px;
      right: 25px;
      background-color: #fff;
      color: #000;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 30px;
      cursor: pointer;
      transition: transform 0.2s ease;
      box-shadow: none;
    }

    .add-btn:hover {
      transform: scale(1.1);
    }

    .side-panel {
      position: absolute;
      top: 0;
      right: -320px;
      width: 300px;
      height: 100%;
      background-color: #181818;
      border-radius: 0 15px 15px 0;
      transition: right 0.4s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 60px;
      z-index: 2;
    }

    .side-panel.open {
      right: -20px;
    }

    .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png');
      background-size: cover;
      background-position: center;
      margin-bottom: 20px;
    }

    .nickname {
      color: white;
      font-size: 18px;
      text-align: center;
    }

    .arrow-btn {
      position: absolute;
      top: 50%;
      right: 50px;
      transform: translateY(-50%);
      width: 55px;
      height: 55px;
      border-radius: 50%;
      background-color: #000;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      transition: all 0.3s ease;
    }

    .arrow-btn:hover {
      transform: translateY(-50%) scale(1.1);
      background-color: #111;
    }

    .side-panel.open + .arrow-btn {
      right: 320px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="room-list" id="roomList"></div>
    <button class="add-btn" id="addRoom">+</button>
  </div>

  <div id="sidePanel" class="side-panel">
    <div class="avatar"></div>
    <div class="nickname" id="nickname">username</div>
  </div>

  <button id="arrowBtn" class="arrow-btn">❯</button>

  <script src="storage.js"></script>
  <script>
    const roomList = document.getElementById("roomList");
    const addRoom = document.getElementById("addRoom");
    const sidePanel = document.getElementById("sidePanel");
    const arrowBtn = document.getElementById("arrowBtn");
    const nicknameEl = document.getElementById("nickname");

    nicknameEl.textContent = Storage.getNickname() || "username";

    // ⛏ Очистка старых комнат каждые 2 секунды
    setInterval(() => {
      const rooms = Storage.getRooms();
      if (rooms.length > 0) {
        const now = Date.now();
        const updated = rooms.filter(r => {
          // если комната создана больше 5 секунд назад и никто в ней не был — удаляем
          return !(now - r.created > 300000 && !r.visited);
        });
        if (updated.length !== rooms.length) {
          Storage.saveRooms(updated);
          renderRooms();
        }
      }
    }, 2000);

    function renderRooms() {
      const rooms = Storage.getRooms();
      roomList.innerHTML = "";
      if (rooms.length === 0) {
        roomList.innerHTML = "<p style='color:#999;text-align:center;margin-top:40%;'>Нет активных комнат</p>";
        return;
      }

      rooms.forEach((room) => {
        const div = document.createElement("div");
        div.className = "room-item";
        div.innerHTML = `<div class="room-circle"></div><span>${room.name}</span>`;
        div.onclick = () => {
          Storage.setCurrentRoom(room.name);
          room.visited = true;
          Storage.updateRoom(room);
          window.location.href = `room.html?room=${encodeURIComponent(room.name)}`;
        };
        roomList.appendChild(div);
      });
    }

    addRoom.onclick = () => {
      const newRoom = prompt("Введите название комнаты:");
      if (!newRoom) return;

      Storage.clearRooms(); // удаляем старую комнату
      const roomData = { name: newRoom.trim(), created: Date.now(), visited: false };
      Storage.saveRooms([roomData]);
      renderRooms();

      // если никто не зайдёт через 5 секунд — комната удаляется
      setTimeout(() => {
        const rooms = Storage.getRooms();
        if (rooms.length > 0 && !rooms[0].visited && rooms[0].name === newRoom.trim()) {
          Storage.clearRooms();
          renderRooms();
          console.log("Комната удалена из-за неактивности:", newRoom);
        }
      }, 5000);

      // переход сразу в комнату
      window.location.href = `room.html?room=${encodeURIComponent(newRoom)}`;
    };

    renderRooms();

    let isOpen = false;
    arrowBtn.onclick = () => {
      isOpen = !isOpen;
      if (isOpen) {
        sidePanel.classList.add("open");
        arrowBtn.textContent = "❮";
        arrowBtn.style.right = "320px";
      } else {
        sidePanel.classList.remove("open");
        arrowBtn.textContent = "❯";
        arrowBtn.style.right = "50px";
      }
    };
  </script>
</body>
</html>
