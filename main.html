document.getElementById("nickname");

nicknameEl.textContent = Storage.getNickname() || "username";

// Очистка старых комнат каждые 2 секунды
setInterval(() => {
  const rooms = Storage.getRooms();
  if (rooms.length > 0) {
    const now = Date.now();
    const updated = rooms.filter(r => !(now - r.created > 300000 && !r.visited));
    if (updated.length !== rooms.length) {
      Storage.saveRooms(updated);
      renderRooms();
    }
  }
}, 2000);

function renderRooms() {
  const rooms = Storage.getRooms();
  roomList.innerHTML = "";
  if (rooms.length === 0) {
    roomList.innerHTML = "<p style='color:#999;text-align:center;margin-top:40%;'>Нет активных комнат</p>";
    return;
  }

  rooms.forEach((room) => {
    const div = document.createElement("div");
    div.className = "room-item";
    div.innerHTML = `<div class="room-circle"></div><span>${room.name}</span>`;
    div.onclick = () => {
      Storage.setCurrentRoom(room.name);
      room.visited = true;
      Storage.updateRoom(room);
      window.location.href = `room.html?room=${encodeURIComponent(room.name)}`;
    };
    roomList.appendChild(div);
  });
}

addRoom.onclick = () => {
  const newRoom = prompt("Введите название комнаты:");
  if (!newRoom) return;

  // при добавлении — можно выбрать видео
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'video/*';
  fileInput.onchange = e => {
    const file = e.target.files[0];
    if (file) {
      player.src = URL.createObjectURL(file);
      player.style.display = 'block';
      player.play();
    }
  };
  fileInput.click();

  Storage.clearRooms();
  const roomData = { name: newRoom.trim(), created: Date.now(), visited: false };
  Storage.saveRooms([roomData]);
  renderRooms();

  // автоудаление комнаты через 5 секунд без входа
  setTimeout(() => {
    const rooms = Storage.getRooms();
    if (rooms.length > 0 && !rooms[0].visited && rooms[0].name === newRoom.trim()) {
      Storage.clearRooms();
      renderRooms();
      console.log("Комната удалена из-за неактивности:", newRoom);
    }
  }, 5000);

  window.location.href = `room.html?room=${encodeURIComponent(newRoom)}`;
};

renderRooms();

let isOpen = false;
arrowBtn.onclick = () => {
  isOpen = !isOpen;
  if (isOpen) {
    sidePanel.classList.add("open");
    arrowBtn.textContent = "❮";
    arrowBtn.style.right = "320px";
  } else {
    sidePanel.classList.remove("open");
    arrowBtn.textContent = "❯";
    arrowBtn.style.right = "50px";
  }
};
</script>
</body>
</html>
