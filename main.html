<script>
// –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∏–∫
const nicknameEl = document.getElementById("nickname");
nicknameEl.textContent = Storage.getNickname() || "username";

const roomList = document.getElementById("roomList");
const addRoom = document.getElementById("addRoom");
const player = document.getElementById("player");
const sidePanel = document.getElementById("sidePanel");
const arrowBtn = document.getElementById("arrowBtn");

// üü¢ –•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ–º–Ω–∞—Ç –Ω–∞ –æ–±—â–µ–º JSON (–Ω–∞–ø—Ä–∏–º–µ—Ä, GitHub Pages –∏–ª–∏ –¥—Ä—É–≥–æ–π URL)
const ROOMS_URL = "https://api.jsonbin.io/v3/b/your-bin-id"; // —Å—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤—å —Å–≤–æ–π ID —Å jsonbin.io
const API_KEY = "YOUR_API_KEY"; // –ø–æ–ª—É—á–∞–µ—à—å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)

// –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–Ω–∞—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
async function fetchRooms() {
  try {
    const res = await fetch(ROOMS_URL + "/latest", {
      headers: { "X-Master-Key": API_KEY }
    });
    const data = await res.json();
    return data.record.rooms || [];
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç:", err);
    return Storage.getRooms(); // fallback –Ω–∞ localStorage
  }
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–Ω–∞—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
async function saveRooms(rooms) {
  try {
    await fetch(ROOMS_URL, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": API_KEY
      },
      body: JSON.stringify({ rooms })
    });
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", err);
  }
}

// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–Ω–∞—Ç –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫
setInterval(async () => {
  const rooms = await fetchRooms();
  if (rooms.length > 0) {
    const now = Date.now();
    const updated = rooms.filter(r => !(now - r.created > 300000 && !r.visited));
    if (updated.length !== rooms.length) {
      await saveRooms(updated);
      Storage.saveRooms(updated);
      renderRooms(updated);
    }
  }
}, 2000);

// –†–µ–Ω–¥–µ—Ä
async function renderRooms(forcedRooms) {
  const rooms = forcedRooms || await fetchRooms();
  roomList.innerHTML = "";
  if (rooms.length === 0) {
    roomList.innerHTML = "<p style='color:#999;text-align:center;margin-top:40%;'>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</p>";
    return;
  }

  rooms.forEach((room) => {
    const div = document.createElement("div");
    div.className = "room-item";
    div.innerHTML = `<div class="room-circle"></div><span>${room.name}</span>`;
    div.onclick = () => {
      Storage.setCurrentRoom(room.name);
      room.visited = true;
      Storage.updateRoom(room);
      window.location.href = `room.html?room=${encodeURIComponent(room.name)}`;
    };
    roomList.appendChild(div);
  });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
addRoom.onclick = async () => {
  const newRoom = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:");
  if (!newRoom) return;

  // –≤—ã–±–æ—Ä –≤–∏–¥–µ–æ
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'video/*';
  fileInput.onchange = e => {
    const file = e.target.files[0];
    if (file) {
      player.src = URL.createObjectURL(file);
      player.style.display = 'block';
      player.play();
    }
  };
  fileInput.click();

  // –Ω–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞
  const roomData = { name: newRoom.trim(), created: Date.now(), visited: false };
  const rooms = await fetchRooms();
  rooms.push(roomData);
  await saveRooms(rooms);
  Storage.saveRooms(rooms);
  renderRooms(rooms);

  // –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã
  setTimeout(async () => {
    const all = await fetchRooms();
    const updated = all.filter(r => !(r.name === roomData.name && !r.visited));
    await saveRooms(updated);
    Storage.saveRooms(updated);
    renderRooms(updated);
  }, 5000);

  window.location.href = `room.html?room=${encodeURIComponent(newRoom)}`;
};

// –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
renderRooms();

// –ü–∞–Ω–µ–ª—å
let isOpen = false;
arrowBtn.onclick = () => {
  isOpen = !isOpen;
  if (isOpen) {
    sidePanel.classList.add("open");
    arrowBtn.textContent = "‚ùÆ";
    arrowBtn.style.right = "320px";
  } else {
    sidePanel.classList.remove("open");
    arrowBtn.textContent = "‚ùØ";
    arrowBtn.style.right = "50px";
  }
};
</script>
