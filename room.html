<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Комната</title>
  <style>
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: #293133;
      font-family: Arial, sans-serif;
      color: #fff;
      overflow: hidden;
    }
    .room-container { display: flex; width: 100%; height: 100vh; }

    .left-side { flex: 1; display: flex; flex-direction: column; background: #293133; border-right: 6px solid #1c2223; }

    .video-container {
      flex: 2; display: flex; position: relative;
      background: #000; border-bottom: 6px solid #1c2223;
      align-items: center; justify-content: center; overflow: hidden;
    }

    .video-inner {
      width: calc(100% - 60px); height: 100%;
      display: flex; align-items: center; justify-content: center;
      background: #000;
    }
    .video-inner iframe,
    .video-inner video {
      width: 100%; height: 100%; border: 0; object-fit: cover; display: block;
    }

    .play-button {
      width: 100px; height: 100px;
      background: white; clip-path: polygon(30% 20%, 30% 80%, 80% 50%);
      cursor: pointer; transition: transform .2s;
    }

    .player-sidebar {
      position: absolute; right: 0; top: 0;
      width: 60px; height: 100%; background: #1c2223;
      display: flex; flex-direction: column; align-items: center;
      padding-top: 16px; gap: 12px; z-index: 2;
    }

    .player-plus {
      width: 42px; height: 42px; border-radius: 50%;
      border: none; background: #000; color: #fff;
      font-size: 22px; cursor: pointer;
    }

    /* Окно встроенного браузера */
    .browser-popup {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 999; flex-direction: column;
    }
    .browser-frame {
      width: 90%; height: 80%;
      border: 4px solid #1c2223;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
    }
    .browser-frame iframe {
      width: 100%; height: 100%; border: none;
    }
    .browser-add {
      position: absolute;
      bottom: 40px; right: 60px;
      background: #00bcd4;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 80px; height: 80px;
      font-size: 40px; cursor: pointer;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .browser-close {
      position: absolute;
      top: 20px; right: 40px;
      background: #ff5555;
      border: none; color: #fff;
      border-radius: 50%;
      width: 40px; height: 40px;
      font-size: 20px; cursor: pointer;
    }

    .chat-container { flex: 1; display: flex; flex-direction: column; background: #293133; }
    .messages { flex: 1; overflow-y: auto; padding: 14px; }
    .message { margin: 6px 0; }
    .message.user strong { color: #00bcd4; margin-right: 6px; }

    .chat-input {
      display: flex; align-items: center; justify-content: center;
      gap: 10px; padding: 12px; background: #1c2223; border-top: 6px solid #000;
    }
    .chat-input input {
      flex: 1; padding: 10px 16px;
      border-radius: 24px; border: none; background: #fff; color: #000; font-size: 14px;
    }
    .send-btn { width: 44px; height: 44px; border-radius: 50%; border: none; background: #000; color: #fff; cursor: pointer; }

    .users-panel {
      width: 110px; background: #293133;
      display: flex; flex-direction: column; align-items: center;
      padding-top: 20px; border-left: 6px solid #1c2223;
    }
    .users-title { font-size: 18px; font-weight: bold; margin-bottom: 12px; }
    .avatars { display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 8px; }
    .user-avatar {
      width: 48px; height: 48px; border-radius: 50%;
      background-image: url('C:/mysite/icons/avatar.png');
      background-size: cover; background-position: center;
      border: 2px solid #1c2223;
    }
  </style>
</head>
<body>
  <div class="room-container">
    <div class="left-side">
      <div class="video-container">
        <div class="video-inner" id="videoInner">
          <div id="player" class="play-button"></div>
        </div>
        <div class="player-sidebar">
          <button id="playerPlus" class="player-plus">+</button>
        </div>
      </div>

      <div class="chat-container">
        <div id="messages" class="messages"><div class="placeholder">Нет сообщений</div></div>
        <div class="chat-input">
          <input id="chatInput" type="text" placeholder="Введите сообщение..." autocomplete="off" />
          <button id="sendBtn" class="send-btn">➤</button>
        </div>
      </div>
    </div>

    <div class="users-panel">
      <div class="users-title">Участники</div>
      <div id="avatarsList" class="avatars"></div>
    </div>
  </div>

  <script>
    const nick = localStorage.getItem('nickname') || 'username';
    const videoInner = document.getElementById('videoInner');

    function setIframe(src) {
      videoInner.innerHTML = `<iframe src="${src}" allowfullscreen></iframe>`;
    }

    // открыть Яндекс.Видео в модальном окне
    document.getElementById('playerPlus').onclick = () => {
      const popup = document.createElement('div');
      popup.className = 'browser-popup';
      popup.innerHTML = `
        <div class="browser-frame">
          <iframe id="searchFrame" src="https://yandex.ru/video/" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
        </div>
        <button class="browser-close">✖</button>
        <button class="browser-add">+</button>
      `;
      document.body.appendChild(popup);

      popup.querySelector('.browser-close').onclick = () => popup.remove();

      popup.querySelector('.browser-add').onclick = () => {
        try {
          const iframe = popup.querySelector('#searchFrame');
          const url = iframe.contentWindow.location.href;
          if (/\.(mp4|webm|ogg)$/i.test(url)) {
            videoInner.innerHTML = `<video src="${url}" controls autoplay></video>`;
          } else if (/rutube\.ru\/video/.test(url)) {
            const match = url.match(/video\/([a-zA-Z0-9]+)/);
            if (match) setIframe(`https://rutube.ru/play/embed/${match[1]}`);
          } else {
            alert("Открой видео на Яндекс.Видео или Rutube, затем нажмите '+' снова.");
            return;
          }
          popup.remove();
        } catch (e) {
          alert("Браузер Яндекса не дал доступ к адресу страницы.\nПопробуйте открыть видео полностью, затем нажать '+'.");
        }
      };
    };

    document.getElementById('sendBtn').onclick = sendMsg;
    document.getElementById('chatInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') sendMsg();
    });

    function sendMsg() {
      const input = document.getElementById('chatInput');
      const msg = input.value.trim();
      if (!msg) return;
      const div = document.createElement('div');
      div.className = 'message user';
      div.innerHTML = `<strong>${nick}:</strong> ${msg}`;
      document.getElementById('messages').appendChild(div);
      input.value = '';
    }
  </script>
</body>
</html>
